#!/bin/bash

# ğŸš€ ä¸€é”®éƒ¨ç½²å’Œè®¾ç½®è„šæœ¬
# ä½¿ç”¨æ–¹æ³•ï¼šsh deploy-and-setup.sh

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          ğŸš€ ä¸€é”®éƒ¨ç½² WhatsApp Agent ç³»ç»Ÿ                       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# æ­¥éª¤1: æ‹‰å–æœ€æ–°ä»£ç 
echo "ğŸ“¥ æ­¥éª¤1: æ‹‰å–æœ€æ–°ä»£ç ..."
git pull origin main

if [ $? -ne 0 ]; then
  echo "âŒ Git pull å¤±è´¥ï¼"
  exit 1
fi

echo "âœ… ä»£ç å·²æ›´æ–°"
echo ""

# æ­¥éª¤2: å®‰è£…ä¾èµ–
echo "ğŸ“¦ æ­¥éª¤2: å®‰è£…ä¾èµ–..."
npm install

if [ $? -ne 0 ]; then
  echo "âŒ npm install å¤±è´¥ï¼"
  exit 1
fi

echo "âœ… ä¾èµ–å·²å®‰è£…"
echo ""

# æ­¥éª¤3: é‡å¯PM2
echo "ğŸ”„ æ­¥éª¤3: é‡å¯æœåŠ¡..."
pm2 restart all

if [ $? -ne 0 ]; then
  echo "âš ï¸  PM2é‡å¯å¤±è´¥ï¼Œå°è¯•å¯åŠ¨..."
  pm2 start ecosystem.config.js
fi

echo "âœ… æœåŠ¡å·²é‡å¯"
echo ""

# æ­¥éª¤4: æ£€æŸ¥é…ç½®æ–‡ä»¶
echo "ğŸ” æ­¥éª¤4: æ£€æŸ¥agenté…ç½®..."

if [ ! -f "config/agents.config.js" ]; then
  echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼"
  exit 1
fi

# æ£€æŸ¥æ˜¯å¦è¿˜æ˜¯é»˜è®¤å·ç 
if grep -q "+60123456789" config/agents.config.js; then
  echo ""
  echo "âš ï¸  æ£€æµ‹åˆ°é»˜è®¤WhatsAppå·ç ï¼Œè¯·å…ˆé…ç½®ï¼š"
  echo ""
  echo "   nano config/agents.config.js"
  echo ""
  echo "   å¡«å…¥3ä¸ªçœŸå®çš„WhatsAppå·ç ï¼Œç„¶åè¿è¡Œï¼š"
  echo "   node scripts/quick-setup-agents.js"
  echo ""
  exit 0
fi

echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
echo ""

# æ­¥éª¤5: è¿è¡Œagentè®¾ç½®
echo "ğŸ¤– æ­¥éª¤5: è®¾ç½®agents..."
echo ""

node scripts/quick-setup-agents.js

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Agentè®¾ç½®å¤±è´¥ï¼"
  echo "è¯·æ£€æŸ¥MongoDBè¿æ¥å’Œé…ç½®æ–‡ä»¶"
  exit 1
fi

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          âœ… éƒ¨ç½²å®Œæˆï¼                                         â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ’¡ ä¸‹ä¸€æ­¥:"
echo "   1. æŸ¥çœ‹æ—¥å¿—: pm2 logs --lines 30"
echo "   2. æŸ¥çœ‹æŠ¥å‘Š: node scripts/agent-distribution-report.js"
echo "   3. æµ‹è¯•: è®¿é—®ç½‘ç«™æäº¤è¡¨å•"
echo ""
